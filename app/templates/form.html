{# app/templates/form.html #}
{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">{{ form_meta.title_en }}</h2>

<form
  action="{{ url_for('submit_form',
                     session_id=session_id,
                     form_slug=form_meta.slug) }}?phone={{ request.query_params.get('phone')|urlencode }}"
  method="post">

  {# keep phone available to the Depends(get_phone) helper on POST #}
  <input type="hidden" name="patient_phone"
         value="{{ request.query_params.get('phone') }}">

  {% for q in questions %}
    <div class="mb-4">

      <p class="fw-semibold">{{ loop.index }}.&nbsp;{{ q.text }}</p>

      {# decide which control to render #}
      {% set kind =
           q.input_type if q.input_type is defined else
           ('text' if (q.options|length == 1 and
                       q.options[0].option_key == 'free_text') else 'radio') %}

      {# ---------- free-text ----------------------------------- #}
      {% if kind == 'text' %}
        <input class="form-control"
               type="text"
               name="q{{ q.id }}">

      {# ---------- multi-select (checkbox) --------------------- #}
      {% elif kind == 'checkbox' %}
        {% for opt in q.options|sort(attribute='order_idx') %}
          <label class="d-block">
            <input type="checkbox"
                   name="q{{ q.id }}[]"
                   value="{{ opt.option_key }}">
            {{ opt.text }}
          </label>
        {% endfor %}

      {# ---------- single-select (radio) ----------------------- #}
      {% else %}
        {% for opt in q.options|sort(attribute='order_idx') %}
          <label class="d-block">
            <input type="radio"
                   name="q{{ q.id }}"
                   value="{{ opt.option_key }}">
            {{ opt.text }}
          </label>
        {% endfor %}
      {% endif %}
    </div>
  {% endfor %}

  <button class="btn btn-primary mt-3" type="submit">Submit</button>
</form>
{% endblock %}
